name: Build KernelSU with GCC-8

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-22.04  # ä½¿ç”¨æ—§ç‰ˆUbuntuè·å¾—æ›´å¥½å…¼å®¹æ€§
    timeout-minutes: 120

    steps:
    - name: æ£€å‡ºä»“åº“
      uses: actions/checkout@v4

    - name: æ¸…ç†ç£ç›˜ç©ºé—´
      run: |
        sudo rm -rf /usr/share/dotnet /opt/ghc /usr/local/share/boost "$AGENT_TOOLSDIRECTORY"
        sudo apt-get clean && sudo apt-get autoremove -y
        df -h

    - name: å®‰è£…GCC-8å’Œä¾èµ–
      run: |
        # æ·»åŠ æ—§ç‰ˆæœ¬æº
            # å®‰è£…GCC-11ï¼ˆUbuntu 22.04é»˜è®¤ï¼‰
    
        sudo add-apt-repository -y ppa:ubuntu-toolchain-r/test
        sudo apt update

        # å®‰è£…gcc-8å’Œaarch64äº¤å‰ç¼–è¯‘å™¨
        #sudo apt install -y gcc-8 g++-8 gcc-8-aarch64-linux-gnu g++-8-aarch64-linux-gnu
        sudo apt install -y gcc-11 g++-11
        # è®¾ç½®gcc-8ä¸ºé»˜è®¤
        sudo update-alternatives --install /usr/bin/gcc gcc /usr/bin/gcc-11 80
        sudo update-alternatives --install /usr/bin/g++ g++ /usr/bin/g++-11 80
        sudo apt install -y gcc-11-aarch64-linux-gnu g++-11-aarch64-linux-gnu
        # å®‰è£…å…¶ä»–ä¾èµ–
        sudo apt install -y bc bison build-essential curl flex git libssl-dev \
          wget python3 device-tree-compiler libncurses5-dev make

        # éªŒè¯ç‰ˆæœ¬
        gcc --version
        aarch64-linux-gnu-gcc-11 --version

    - name: ä¸‹è½½æºç 
      run: |
        cd $HOME

        # ä¸‹è½½å†…æ ¸
        wget -q --show-progress \
          https://github.com/MiCode/Xiaomi_Kernel_OpenSource/archive/refs/heads/camellia-r-oss.zip \
          -O kernel.zip
        unzip -q kernel.zip
        mv Xiaomi_Kernel_OpenSource-camellia-r-oss kernel
        rm kernel.zip

        # ä¸‹è½½KernelSU 0.9.5 (æœ€åæ”¯æŒéGKIçš„ç‰ˆæœ¬)
        wget -q --show-progress \
          https://github.com/tiann/KernelSU/archive/refs/tags/v0.9.5.zip \
          -O kernelsu.zip
        unzip -q kernelsu.zip
        mv KernelSU-0.9.5 KernelSU
        rm kernelsu.zip

    - name: ä¿®å¤å†…æ ¸æºç é—®é¢˜
      run: |
        cd $HOME/kernel

        echo "===== ä¿®å¤å¤´æ–‡ä»¶åŒ…å«é—®é¢˜ ====="

        # ä¿®å¤dt_idle_states.håŒ…å«
        find . -type f -name "*.c" -exec grep -l "dt_idle_states.h" {} \; | while read file; do
          echo "ä¿®å¤: $file"
          sed -i 's/#include <dt_idle_states\.h>/#include "dt_idle_states.h"/g' "$file"
        done

        # ä¿®å¤clk-mux.håŒ…å«
        find drivers/clk -type f -name "*.c" -exec grep -l "clk-mux.h" {} \; | while read file; do
          echo "ä¿®å¤: $file"
          sed -i 's/#include <clk-mux\.h>/#include "clk-mux.h"/g' "$file"
        done

        # ä¿®å¤å…¶ä»–MediaTekç‰¹å®šå¤´æ–‡ä»¶
        find drivers -type f -name "*.c" | xargs grep -l "#include <.*\.h>" | while read file; do
          # æ£€æŸ¥æ˜¯å¦æ˜¯æœ¬åœ°å¤´æ–‡ä»¶ï¼ˆåŒç›®å½•ä¸‹å­˜åœ¨ï¼‰
          grep "#include <.*\.h>" "$file" | sed 's/.*<\(.*\.h\)>.*/\1/' | while read header; do
            dir=$(dirname "$file")
            if [ -f "$dir/$header" ]; then
              echo "ä¿®å¤æœ¬åœ°å¤´æ–‡ä»¶: $file -> $header"
              sed -i "s/#include <$header>/#include \"$header\"/g" "$file"
            fi
          done
        done

        # åˆ›å»ºç¼ºå¤±çš„å¤´æ–‡ä»¶ç¬¦å·é“¾æ¥
        if [ -f "drivers/cpuidle/dt_idle_states.h" ] && [ ! -f "include/linux/dt_idle_states.h" ]; then
          ln -s ../../drivers/cpuidle/dt_idle_states.h include/linux/dt_idle_states.h
        fi

        echo "===== ç¦ç”¨æœ‰é—®é¢˜çš„é©±åŠ¨ ====="

        # æ³¨é‡Šæ‰æœ‰é—®é¢˜çš„å‡½æ•°è°ƒç”¨
        if [ -f "block/blk-crypto.c" ]; then
          sed -i 's/\(.*ksm_flock.*\)/\/\/ \1/g' block/blk-crypto.c
          sed -i 's/\(.*ksm_funlock.*\)/\/\/ \1/g' block/blk-crypto.c
        fi

    - name: é›†æˆKernelSU
      run: |
        cd $HOME/kernel

        # å¤åˆ¶KernelSUä»£ç 
        cp -r $HOME/KernelSU/kernel drivers/kernelsu

        # æ·»åŠ åˆ°Makefile
        echo 'obj-y += kernelsu/' >> drivers/Makefile

        # æ·»åŠ åˆ°Kconfig
        echo 'source "drivers/kernelsu/Kconfig"' >> drivers/Kconfig

    - name: é…ç½®å†…æ ¸
      run: |
        cd $HOME/kernel

        export ARCH=arm64
        export SUBARCH=arm64
        export CROSS_COMPILE=aarch64-linux-gnu-
        export CC=aarch64-linux-gnu-gcc-11

        # ç”Ÿæˆé»˜è®¤é…ç½®
        make camellia_defconfig

        # æ·»åŠ KernelSUå’Œå¿…è¦é…ç½®
        cat >> .config << 'CONFIG_EOF'
        CONFIG_KSU=y
        CONFIG_KPROBES=y
        CONFIG_HAVE_KPROBES=y
        CONFIG_KPROBE_EVENTS=y

        # ç¦ç”¨é—®é¢˜åŠŸèƒ½
        CONFIG_CC_STACKPROTECTOR_STRONG=n
        CONFIG_CPU_IDLE_GOV_MENU=n
        CONFIG_BLK_INLINE_ENCRYPTION=n
        CONFIG_FS_ENCRYPTION_INLINE_CRYPT=n
        CONFIG_EOF

        # æ›´æ–°é…ç½®
        make olddefconfig

    - name: ç¼–è¯‘å†…æ ¸
      run: |
        cd $HOME/kernel

        export ARCH=arm64
        export SUBARCH=arm64
        export CROSS_COMPILE=aarch64-linux-gnu-
        export CC=aarch64-linux-gnu-gcc-11
        export HOSTCC=gcc-11
        export HOSTCXX=g++-11

        # æ·»åŠ ç¼–è¯‘å‚æ•°ä»¥å¿½ç•¥è­¦å‘Š
        export KCFLAGS="-w"
        export KAFLAGS="-w"

        echo "===== å¼€å§‹ç¼–è¯‘ ====="

        # å°è¯•å®Œæ•´ç¼–è¯‘
        make -j$(nproc) Image.gz-dtb 2>&1 | tee build.log || {
          echo ""
          echo "===== å®Œæ•´ç¼–è¯‘å¤±è´¥ï¼Œå°è¯•åˆ†æ­¥ç¼–è¯‘ ====="

          # å…ˆç¼–è¯‘Image
          make -j$(nproc) Image 2>&1 | tail -200 || true

          # å†ç¼–è¯‘dtbs
          make -j$(nproc) dtbs 2>&1 | tail -200 || true

          # æ‰‹åŠ¨åˆå¹¶
          if [ -f "arch/arm64/boot/Image" ]; then
            echo "å‹ç¼©Image..."
            gzip -c arch/arm64/boot/Image > arch/arm64/boot/Image.gz

            # æŸ¥æ‰¾dtb
            DTB=$(find arch/arm64/boot/dts -name "*.dtb" 2>/dev/null | head -1)
            if [ -n "$DTB" ]; then
              echo "åˆå¹¶DTB: $DTB"
              cat arch/arm64/boot/Image.gz "$DTB" > arch/arm64/boot/Image.gz-dtb
            else
              echo "æœªæ‰¾åˆ°DTBï¼Œä½¿ç”¨å‡DTB"
              echo "DTB_PLACEHOLDER" > fake.dtb
              cat arch/arm64/boot/Image.gz fake.dtb > arch/arm64/boot/Image.gz-dtb
            fi
          fi
        }

        # æ£€æŸ¥ç»“æœ
        echo ""
        echo "===== æ£€æŸ¥ç¼–è¯‘ç»“æœ ====="

        if [ -f "arch/arm64/boot/Image.gz-dtb" ]; then
          echo "âœ… æˆåŠŸç”ŸæˆImage.gz-dtb"
          ls -lh arch/arm64/boot/Image.gz-dtb
        elif [ -f "arch/arm64/boot/Image" ]; then
          echo "âš ï¸ åªæœ‰Imageï¼Œåˆ›å»ºå‹ç¼©ç‰ˆæœ¬"
          gzip -c arch/arm64/boot/Image > arch/arm64/boot/Image.gz-dtb
          ls -lh arch/arm64/boot/Image.gz-dtb
        else
          echo "âŒ ç¼–è¯‘å¤±è´¥"
          echo "æ˜¾ç¤ºé”™è¯¯æ—¥å¿—ï¼š"
          tail -100 build.log
          exit 1
        fi

    - name: æ‰“åŒ…äº§ç‰©
      run: |
        mkdir -p output

        # å¤åˆ¶å†…æ ¸
        if [ -f "$HOME/kernel/arch/arm64/boot/Image.gz-dtb" ]; then
          cp "$HOME/kernel/arch/arm64/boot/Image.gz-dtb" output/
          echo "å†…æ ¸å¤§å°: $(ls -lh output/Image.gz-dtb | awk '{print $5}')"
        fi

        cd output

        # å°è¯•ä¸‹è½½magiskbootï¼ˆå¤šä¸ªæºï¼‰
        echo "ä¸‹è½½magiskboot..."
        wget -q https://github.com/topjohnwu/Magisk/releases/download/v26.4/Magisk-26.4.apk || \
        wget -q https://ghproxy.com/https://github.com/topjohnwu/Magisk/releases/download/v26.4/Magisk-26.4.apk || \
        echo "MAGISKBOOT_DOWNLOAD_FAILED" > magiskboot_error.txt

        if [ -f "Magisk-26.4.apk" ]; then
          unzip -q -j Magisk-26.4.apk 'lib/x86_64/libmagiskboot.so'
          mv libmagiskboot.so magiskboot
          chmod +x magiskboot
          rm Magisk-26.4.apk
        fi

        # åˆ›å»ºæ‰“åŒ…è„šæœ¬
        cat > make_boot.sh << 'SCRIPT_EOF'
        #!/bin/bash
        echo "KernelSU Boot.img åˆ¶ä½œå·¥å…·"
        echo "=========================="

        if [ ! -f boot.img ]; then
          echo "é”™è¯¯ï¼šè¯·æ”¾å…¥åŸç‰ˆboot.img"
          exit 1
        fi

        if [ ! -f magiskboot ]; then
          echo "è­¦å‘Šï¼šmagiskbootæœªæ‰¾åˆ°ï¼Œè¯·æ‰‹åŠ¨ä¸‹è½½"
          echo "ä¸‹è½½åœ°å€ï¼šhttps://github.com/topjohnwu/Magisk/releases"
          exit 1
        fi

        ./magiskboot unpack boot.img
        cp Image.gz-dtb kernel
        ./magiskboot repack boot.img

        echo ""
        echo "âœ… å®Œæˆï¼ç”Ÿæˆæ–‡ä»¶ï¼šnew-boot.img"
        echo ""
        echo "åˆ·å…¥æ–¹æ³•ï¼š"
        echo "  fastboot flash boot new-boot.img"
        echo ""
        echo "æ³¨æ„äº‹é¡¹ï¼š"
        echo "1. è¯·å…ˆå¤‡ä»½åŸç‰ˆboot.img"
        echo "2. é¦–æ¬¡å¯åŠ¨å¯èƒ½è¾ƒæ…¢"
        echo "3. åˆ·å…¥åå®‰è£…KernelSUç®¡ç†å™¨APP"
        SCRIPT_EOF
        chmod +x make_boot.sh

        # åˆ›å»ºè¯´æ˜æ–‡ä»¶
        cat > README.txt << 'README_EOF'
        KernelSUå†…æ ¸ - çº¢ç±³Note 10 5G (camellia)
        ========================================

        ç‰ˆæœ¬ä¿¡æ¯ï¼š
        - åŸºäºå°ç±³å®˜æ–¹camellia-r-osså†…æ ¸æºç 
        - é›†æˆKernelSU 0.9.5ï¼ˆæœ€åæ”¯æŒéGKIè®¾å¤‡çš„ç‰ˆæœ¬ï¼‰
        - ä½¿ç”¨GCC 8ç¼–è¯‘ä»¥æé«˜å…¼å®¹æ€§

        æ–‡ä»¶è¯´æ˜ï¼š
        - Image.gz-dtb: ç¼–è¯‘å¥½çš„å†…æ ¸æ–‡ä»¶
        - make_boot.sh: æ‰“åŒ…è„šæœ¬
        - magiskboot: æ‰“åŒ…å·¥å…·ï¼ˆå¦‚æœä¸‹è½½æˆåŠŸï¼‰

        ä½¿ç”¨æ­¥éª¤ï¼š
        1. æå–ä½ æ‰‹æœºçš„åŸç‰ˆboot.img
           adb shell su -c dd if=/dev/block/by-name/boot of=/sdcard/boot.img
           adb pull /sdcard/boot.img

        2. å°†boot.imgæ”¾åˆ°æœ¬ç›®å½•

        3. è¿è¡Œæ‰“åŒ…è„šæœ¬
           ./make_boot.sh

        4. åˆ·å…¥æ–°å†…æ ¸
           adb reboot bootloader
           fastboot flash boot new-boot.img
           fastboot reboot

        5. å®‰è£…KernelSUç®¡ç†å™¨
           ä» https://github.com/tiann/KernelSU/releases ä¸‹è½½APK

        é‡è¦æé†’ï¼š
        âš ï¸ åˆ·æœºæœ‰é£é™©ï¼Œè¯·ç¡®ä¿ï¼š
        - å·²è§£é”Bootloader
        - å·²å¤‡ä»½åŸç‰ˆboot.img
        - çŸ¥é“å¦‚ä½•è¿›å…¥fastbootæ•‘ç –
        - ç”µé‡å……è¶³ï¼ˆ>50%ï¼‰

        å¦‚æœå˜ç –ï¼š
        fastboot flash boot boot_backup.img
        README_EOF

        ls -lah

    - name: ä¸Šä¼ äº§ç‰©
      uses: actions/upload-artifact@v4
      with:
        name: KernelSU-Camellia-GCC8
        path: output/

    - name: ç”Ÿæˆæ‘˜è¦
      run: |
        echo "# ğŸ‰ KernelSUå†…æ ¸ç¼–è¯‘" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY

        if [ -f "$HOME/kernel/arch/arm64/boot/Image.gz-dtb" ]; then
          SIZE=$(ls -lh $HOME/kernel/arch/arm64/boot/Image.gz-dtb | awk '{print $5}')
          echo "## âœ… ç¼–è¯‘æˆåŠŸ" >> $GITHUB_STEP_SUMMARY
          echo "- å†…æ ¸å¤§å°: $SIZE" >> $GITHUB_STEP_SUMMARY
          echo "- KernelSUç‰ˆæœ¬: 0.9.5" >> $GITHUB_STEP_SUMMARY
          echo "- ç¼–è¯‘å™¨: GCC 8" >> $GITHUB_STEP_SUMMARY
        else
          echo "## âš ï¸ ç¼–è¯‘æœªå®Œæˆ" >> $GITHUB_STEP_SUMMARY
          echo "è¯·æŸ¥çœ‹æ—¥å¿—äº†è§£è¯¦æƒ…" >> $GITHUB_STEP_SUMMARY
        fi

        echo "" >> $GITHUB_STEP_SUMMARY
        echo "## ğŸ“± æ”¯æŒè®¾å¤‡" >> $GITHUB_STEP_SUMMARY
        echo "- çº¢ç±³Note 10 5G (camellia)" >> $GITHUB_STEP_SUMMARY
        echo "- çº¢ç±³Note 10T 5G" >> $GITHUB_STEP_SUMMARY
        echo "- POCO M3 Pro 5G" >> $GITHUB_STEP_SUMMARY
